---
title: "piwikr"
subtitle: "Custom Web Analytics with Piwik and R"
author: "Andrew Marder"
date: "`r Sys.Date()`"
output: rmarkdown::html_document
vignette: >
  %\VignetteIndexEntry{piwikr}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r, echo=FALSE, warning=FALSE}
library(knitr)

opts_chunk$set(warning=FALSE, message=FALSE)
```

[Piwik][piwik] is the web analytics framework for hackers. By providing access to raw page view data, Piwik allows analysts to use general purpose tools for analysis. Piwik stores all of its data in a MySQL database. To get started let's connect to the database using `RMySQL` and `dplyr`:

```{r, eval=FALSE}
library(RMySQL)
library(dplyr)

my_db <- src_mysql(
    host='host.com',
    user='root',
    password='pass',
    dbname='piwik'
    )
```

```{r, echo=FALSE}
## Obviously, I don't want to share my database credentials with the
## world, so I am following Hadley Wickham's advice of storing
## passwords in environment variables.
##
## http://blog.revolutionanalytics.com/2015/11/how-to-store-and-use-authentication-details-with-r.html#comments
##
## The code below sets up my database connection by pulling the
## appropriate information from the system environment.

library(RMySQL)
library(dplyr)

keys <- c('dbname', 'host', 'port', 'user', 'password')
values <- lapply(keys, function(x) Sys.getenv(paste0('MYSQL_', toupper(x))))
names(values) <- keys
values$port <- as.integer(values$port)
my_db <- do.call(src_mysql, values)
```

I've written an R library `piwikr` to download and clean the tables stored in Piwik's database. Below I retrieve tables describing all visits to the site and all actions taken by visitors to the site.

```{r}
library(piwikr)

visits <- get_visits(my_db)
actions <- get_actions(my_db)
```

# Traffic Over Time

How much traffic has the site generated over time?

```{r, fig.width=7}
library(ggplot2)
library(lubridate)

visitors <- actions %>%
    mutate(day=floor_date(actions$datetime, 'day')) %>%
    group_by(visitor_id) %>%
    summarise(day_of_first_visit=min(day))

date_range <- function(x) seq(min(x), max(x), by='days')
grid <- data.frame(day_of_first_visit=date_range(visitors$day_of_first_visit))

days <- visitors %>%
    group_by(day_of_first_visit) %>%
    summarise(new_visitors=n()) %>%
    right_join(grid, by='day_of_first_visit') %>%
    mutate(new_visitors=ifelse(is.na(new_visitors), 0, new_visitors))

(
    ggplot(days, aes(x=day_of_first_visit, y=new_visitors)) +
    geom_point() +
    geom_line() +
    ggtitle('New Visitors over Time') +
    ylab('New Visitors') +
    xlab('') +
    theme_classic()
)

ndays <- as.numeric(
    max(visitors$day_of_first_visit) - min(visitors$day_of_first_visit)
    )
```

The site has attracted `r nrow(visitors)` visitors over `r ndays` days. The average arrival rate was `r round(nrow(visitors) / ndays, 2)` visitors per day.

# Popular Content

What pages on the site have been viewed by the most visitors?

```{r, results='asis'}
library(pander)

pages <- actions %>%
    group_by(url) %>%
    summarise(n=length(unique(visitor_id))) %>%
    arrange(desc(n)) %>%
    filter(grepl('amarder.github.io', url)) %>%
    mutate(Page=sub('amarder.github.io', '', url), Visitors=n) %>%
    mutate(Page=paste0('<a href="', Page, '">', Page, '</a>')) %>%
    select(Page, Visitors)

pandoc.table(pages, style='rmarkdown', split.table=Inf, justify='ll')
```

# Referrals

How are visitors finding the site?

```{r, results='asis'}
visitors <- visits %>%
    group_by(idvisitor) %>%
    arrange(visit_first_action_time) %>%
    do(head(., 1)) %>%
    ungroup()

sources <- visitors %>%
    mutate(referer_name=ifelse(referer_type == 1, '(direct)', referer_name)) %>%
    group_by(referer_name) %>%
    summarise(Visitors=n()) %>%
    arrange(desc(Visitors)) %>%
    select(Source=referer_name, Visitors) %>%
    filter(Visitors > 1)

pandoc.table(sources, style='rmarkdown', justify='ll')
```

# Browser Resolutions

How important is mobile / how large are my visitors' browser windows?

```{r}
library(tidyr)

resolutions <- visits %>%
    separate(config_resolution, c('width', 'height'), sep='x', convert=TRUE) %>%
    group_by(width, height) %>%
    summarise(n=n()) %>%
    ungroup() %>%
    mutate(proportion=n / sum(n))

(
    ggplot(resolutions, aes(xmin=0, xmax=width, ymin=0, ymax=height, alpha=proportion)) +
    geom_rect(fill=NA, color='black') +
    theme_classic() +
    theme(legend.position='none') +
    coord_fixed(ratio = 1) +
    ggtitle('Browser Resolutions') +
    ylab('Height') +
    xlab('Width')
)
```

# Graphing Site Structure

Using the `igraph` library, we can plot how users navigate from page to page on the site. Each node represents a page on the site, the size of a node is proportional to the number of visitors that have viewed the page. The width of each edge is proportional to the number of visitors that traveled from the source page to the destination page.

```{r}
library(igraph)

views <- actions %>%
    filter(grepl('amarder.github.io', url)) %>%
    mutate(page=sub('amarder.github.io', '', url))
        
pages <- views %>%
    group_by(page) %>%
    summarise(n=n()) %>%
    ungroup() %>%
    mutate(page_id=row_number(n))

views <- views %>%
    group_by(visit_id) %>%
    mutate(t = (datetime - min(datetime)) / dminutes(1), n=n()) %>%
    arrange(datetime) %>%
    mutate(previous_page=lag(page)) %>%
    ungroup()

edges <- views %>%
    filter(!is.na(previous_page), previous_page != page) %>%
    group_by(previous_page, page) %>%
    summarise(n=n())

g <- graph_from_data_frame(edges, directed=TRUE, vertices=pages)
edge_importance <- 5 * E(g)$n / max(E(g)$n)
vertex_importance <- V(g)$n / max(V(g)$n)
layout <- layout.auto(g)
root_vertex <- V(g)$name == '/'
origin <- layout[root_vertex, ]
above_x_axis <- layout[, 2] > origin[2]
vertex_diameter <- 30 * vertex_importance
dist <- 0.7 * vertex_importance^(1/3)
dist[dist < 0.3] <- 0.3
dist[root_vertex] <- 0

plot(
    g,
    vertex.size=vertex_diameter,
    edge.width=1 * edge_importance,
    edge.arrow.size=0.1 * edge_importance,
    edge.curved=TRUE,
    layout=layout,
    vertex.label.dist=dist,
    vertex.label.degree=ifelse(above_x_axis, -pi/2, pi/2)
    )
```

[piwik]: http://piwik.org/
[piwik-faq]: http://piwik.org/faq/troubleshooting/faq_51/
